<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WAT Calendars</title>
</head>
<body>
<h1>WAT Calendars</h1>
<div id="content">Loading...</div>
<script>
(async function(){
  const owner='dominikx2002';
  const repo='WATcalendars';
  const branch='main';
  const baseApi=`https://api.github.com/repos/${owner}/${repo}/contents/db`;
  const params=new URLSearchParams(window.location.search);
  const dir=params.get('dir');
  const contentDiv=document.getElementById('content');
  function folderLink(name){ const a=document.createElement('a'); a.href='?dir='+encodeURIComponent(name); a.textContent=name; return a; }
  async function forceDownload(url,name){
    try{ const r=await fetch(url); if(!r.ok) throw new Error(r.status); const blob=await r.blob(); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},1500);}catch(e){alert('Download failed: '+e);} }
  function fileLink(rawUrl,name){ const a=document.createElement('a'); a.href='#'; a.textContent=name; a.style.textDecoration='underline'; a.addEventListener('click',e=>{ e.preventDefault(); forceDownload(rawUrl,name); }); return a; }
  try {
    if(!dir){
      const res=await fetch(baseApi); if(!res.ok){contentDiv.textContent='Error loading directory list';return;}
      const data=await res.json();
      const scheduleDirs=data.filter(e=>e.type==='dir' && /schedules/i.test(e.name) && e.name.toLowerCase()!=='groups')
                             .map(e=>e.name).sort();
      if(!scheduleDirs.length){contentDiv.textContent='No schedule folders found.';return;}
      contentDiv.textContent='';
      scheduleDirs.forEach(d=>{ const line=document.createElement('div'); line.appendChild(folderLink(d)); contentDiv.appendChild(line); });
    } else {
      const back=document.createElement('div'); const backA=document.createElement('a'); backA.href='./'; backA.textContent='[Back]'; back.appendChild(backA); contentDiv.innerHTML=''; contentDiv.appendChild(back);
      const h2=document.createElement('h2'); h2.textContent=dir; contentDiv.appendChild(h2);
      const res=await fetch(`${baseApi}/${encodeURIComponent(dir)}`); if(!res.ok){contentDiv.appendChild(document.createTextNode('Error loading files.'));return;}
      const data=await res.json();
      const ics=data.filter(e=>e.type==='file' && e.name.toLowerCase().endsWith('.ics')).sort((a,b)=>a.name.localeCompare(b.name));
      if(!ics.length){ const p=document.createElement('p'); p.textContent='No ICS files.'; contentDiv.appendChild(p); return; }
      ics.forEach(f=>{ const raw=f.download_url || f.url; const line=document.createElement('div'); line.appendChild(fileLink(raw,f.name)); contentDiv.appendChild(line); });
      const note=document.createElement('p'); note.textContent='Click a calendar name to download (.ics).'; contentDiv.appendChild(note);
    }
  } catch(e){ contentDiv.textContent='Unexpected error.'; }
})();
</script>
</body>
</html>